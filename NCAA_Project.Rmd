```{R}
Packages <- c("maps", "plyr", "googleVis", "gsubfn", "rvest",
              "tm", "stringr", "dplyr", "tidyverse", "caret",
              "corrplot", "DescTools", "rlist", "class")
invisible(lapply(lapply(Packages, rlang::quo_name),
                 library, character.only = TRUE))

## Primary Scraping Function for data from sports-reference.com##
Data.Scrape = function(years) {
  result = list()
  for (year in years){
  webpage = sprintf("https://www.sports-reference.com/cbb/seasons/%s-advanced-school-stats.html", year)
  wp = read_html(webpage)
  
  a = wp %>% html_node("p:nth-child(1)")
  temp.a = data.frame(Year = html_text(a))
  
  b = wp %>% html_nodes("td.left")
  temp.b = data.frame(Team = html_text(b))
  
  temp.c = as.numeric(html_text(wp %>% html_nodes("td.right")))
  temp.c = matrix(temp.c, nrow = nrow(temp.b), ncol = length(temp.c)/nrow(temp.b), byrow = TRUE)

  MM.TrainTest = str_detect(as.matrix(temp.b),"NCAA")
  MM.TrainTest = data.frame(MM.TrainTest)
  
  data.temp = data.frame(temp.a, temp.b,MM.TrainTest, temp.c)
  data.temp$Team = str_replace(data.temp$Team, "NCAA", "")
  data.temp$Team = str_trim(data.temp$Team, side = "right")
  data.temp$MM.TrainTest = as.factor(data.temp$MM.TrainTest)

  ## Pulling the Final Four teams data from each season. Not all pages are the same##
  ## Matching the Final Four dataset to create a new TestTrain column variable for modeling ##
  for (h in 1:7){
    text.str = sprintf("p:nth-child(%s)", h)
    find = wp %>% html_element(text.str) %>% html_text()
    text.find = strapply(find, "Final Four", empty = FALSE, simplify = TRUE)
    if (text.find == "Final Four")
      n = h
  }
  
  ## Text transformation and hard coding to extrapolate the Final Four Teams ##
  text.str = sprintf("p:nth-child(%s)", n)
  text = wp %>% html_element(text.str) %>% html_text()
  text = unlist(strsplit(text, ","))
  text = unlist(strsplit(text, "and"))
  text = unlist(strsplit(text, ":"))
  text = trimws(text, "l")
  text = trimws(text, "r")
  FF = data.frame(text)
  FF.Text = gsub("UConn", "Connecticut", FF$text)
  FF2 = data.frame(FF.Text)
  FF.Text2 = gsub("UNC", "North Carolina", FF2$FF.Text)
  FF3 = data.frame(FF.Text2)
  
  ## For Loop to add Test and Training column variable ##
  data.temp$FF = FALSE
  for (i in 1:length(data.temp$Team)) {
    for (j in 1:length(FF3$FF.Text2)) {
      if (data.temp$Team[i] == FF3$FF.Text2[j])
        data.temp$FF[i] = TRUE
    }
  }
}
  return(data.temp)
}

################################################################################
## Running Function and binding data ##
year.string = as.character(seq.int(2011, 2021, 1))
Main.data = list.rbind(lapply(year.string, FUN = Data.Scrape))

################################################################################
## Applying the appropriate Column Headings for the data ##
webpage = sprintf("https://www.sports-reference.com/cbb/seasons/%s-advanced-school-stats.html", 2021)
wp.2 = read_html(webpage)
temp.d = matrix(html_text(wp.2 %>% html_nodes(".poptip")), nrow = 1)
colnames(Main.data)[4:35] = temp.d[3:34]
Main.data$FF.TrainTest  = as.factor(Main.data$FF)
Main.data = Main.data %>% 
  relocate(FF.TrainTest, .after = MM.TrainTest) %>%
  select(-FF)
emptycols = sapply(Main.data, function(k) all(is.na(k)))
Main.data <- Main.data[!emptycols]

################################################################################
## Preprocessing of Data ##
Main.data$FF.TrainTest = revalue(Main.data$FF.TrainTest, c("TRUE" = "1", "FALSE" = "0"))
Main.data$MM.TrainTest = revalue(Main.data$MM.TrainTest, c("TRUE" = "1", "FALSE" = "0"))
Main.data = Main.data %>%
  filter(Year != "2020-21 Season Pages")%>%
  filter(W.1 != "NA")

## Subset of Teams that made the Tournament'MM.TestTrain' factored dataset ##
MM.Teams = Main.data %>%
  filter(MM.TrainTest == "1")

Final4.Teams = Main.data %>%
  filter(FF.TrainTest == "1")

## Building Bar Chart of Teams who made it to the Championship Tournament ##
Main.data.cat = Main.data[1:4]
Main.data.num = Main.data[5:31]
round(prop.table(table(Main.data.cat$MM.TrainTest)), 2) * 100

Contenders = Main.data.cat %>%
  filter(MM.TrainTest == "1")
Contenders = data.frame(table(Contenders$Team))
Contenders = Contenders[order(-Contenders[,2]),]

plot(gvisBarChart(Contenders,
                  options = list(chartArea ="{left:150,top:50,width:\"50%\",height:\"75%\"}",
                                 width ="1500px", 
                                 height="500px",
                                 title = "Champion Teams",
                                 vAxis = "{title:'Teams',textStyle:{fontSize:12}}",
                                 hAxis = "{title:'Tournament Appearances'}")))

################################################################################
### Correlation Chart ###
cor.mtest <- function(mat, ...) {
  mat <- as.matrix(mat)
  n <- ncol(mat)
  p.mat<- matrix(NA, n, n)
  diag(p.mat) <- 0
  for (i in 1:(n - 1)) {
    for (j in (i + 1):n) {
      tmp <- cor.test(mat[, i], mat[, j], ...)
      p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
    }
  }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

p.mat = cor.mtest(Main.data.num)
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(cor(Main.data.num), 
         col=col(200), order = "hclust",type = "upper",
         tl.col="black", tl.srt = 90, tl.cex = .75,
         title = "Correlation Plot w/ P-Value of .01"
         ,p.mat = p.mat, 
         sig.level = 0.01, 
         insig = "blank")

# Correlation ##
Coer.data = Main.data[4:31]
for (i in 1:ncol(Coer.data)){
  j = colnames(Coer.data[i])
  ContCoef = ContCoef(Coer.data[[i]], Coer.data[[1]])
  if(ContCoef > .1) 
    cat(j, '=', ContCoef, '\n')
}

Model.ds = Main.data[c("Year","Team","MM.TrainTest","FF.TrainTest", "W-L%","SRS","SOS","Tm.","Opp.","ORtg")]

################################################################################
### The top five winning teams for the past 10 seasons ###
ggplot(Main.data, aes(x = W)) + 
  geom_histogram(binwidth = 5, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  ggtitle("Histogram of Team Wins")

Model.ds1 = Model.ds %>%
  filter(MM.TrainTest == "1")

Top.Win.Teams = Model.ds1[order(-Model.ds1[,6] ),]
Top.5.Teams = head(Top.Win.Teams, 5)
Bottom.5.Teams = tail(Top.Win.Teams, 5)
TopBottom.5.Teams = rbind(Top.5.Teams, Bottom.5.Teams)
view(TopBottom.5.Teams)
plot(gvisBubbleChart(TopBottom.5.Teams,idvar = "Team",xvar = "W-L%", 
                     yvar ="Tm.",colorvar = "Opp.",sizevar = "FF.TrainTest",
                     options=list(chartArea ="{left:150,top:50,width:\"50%\",height:\"75%\"}",
                                  width ="1500px", height="500px",
                                  title = "Top 5 and Bottom 5 Teams by Wins who Played in the Tournament",
                                  titlePosition = 'out',
                                  vAxis = "{title:'Total Team Points'}",
                                  hAxis = "{title:'Win and Loss Percentage'}",
                                  chartArea ="{left:150,top:50,width:\"50%\",height:\"75%\"}",
                                  width ="1500px", height="500px",
                                  bubble = "{textStyle:{color:'black', fontSize: 8}}",
                                  colorAxis = "{colors:['grey', 'blue']}")))

################################################################################
### Build of Model ###    
# Normalizing Data for Model #
normalize = function(x){
  return((x - min(x)) / (max(x) - min(x)))}
Model.subset = Model.ds[c("MM.TrainTest", "W-L%","SRS","SOS","Tm.","Opp.","ORtg")]
Model.ds.subset = as.data.frame(lapply(Model.subset[2:6], normalize))
dat.d = sample(1:nrow(Model.ds.subset), size = nrow(Model.ds.subset) * 0.7, replace=FALSE)

train.dataset = Model.subset[dat.d,]
test.dataset = Model.subset[-dat.d,]
train.dataset.label = Model.subset[dat.d,1]
test.dataset.label = Model.subset[-dat.d,1]

## Classification Results using KNN modeling ##
set.seed(20210427)

# For Loop to identify the best k value to use for the best results #
a = train.dataset
b = test.dataset
c = train.dataset.label
i = 1 
k.optm = 1
for (i in 1:28){
  knn.mod = knn(train = a, test = b, cl = c, k = i)
  k.optm[i] = 100 * sum(c == knn.mod) / NROW(c)
  k = i
  cat(k, '=', k.optm[i], '\n')
}

plot(k.optm, type = "b", 
     xlab = "K - Value", 
     ylab = "Accuracy level", 
     main = "Maximum Percentage Accuracy Graph")

set.seed(20210427)
knn.pred = knn(train = a, test = b, cl = c, k = 24, prob = T)
table(knn.pred, test.dataset.label)
confusionMatrix(table(knn.pred, test.dataset.label))

```