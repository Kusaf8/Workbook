```{R}

# INSTALL NECESSARY R PACKAGES
Packages <- c("tidyr", "dplyr", "tibble", 
              "ggplot2","corrplot", "skimr", "tm","english", "stringr")

invisible(lapply(lapply(Packages, rlang::quo_name),
                 library, character.only = TRUE))

# IMPORT FLIGHT DATASET FILE
FLIGHT = read.csv("C:\\Users\\Kevin\\Desktop\\CodePractice\\APACS\\APACS_Study.csv", header = TRUE)

# MODIFY TO SIMPLIFY COLUMN NAMES OF FLIGHT DATASET
colnames(FLIGHT) = c('Submitted', 'Status', 'Clearance', 'ArrivalDate', 'Type', 'Airport', 'ICAO','Hazmat', 'Purpose')

# CLEAN CLEARANCE, TYPE, ICAO DATA VARIABLES TO REDUCE ERRORS
FLIGHT$Clearance = gsub('\\s+', '',FLIGHT$Clearance)
FLIGHT$Type = gsub('-', '',FLIGHT$Type)
FLIGHT$Type = toupper(FLIGHT$Type)
FLIGHT$ICAO = gsub('\\s+', '',FLIGHT$ICAO)
FLIGHT$ICAO = toupper(FLIGHT$ICAO)

# CREATE NEW COLUMN TO IDENTIFY YEAR OF TUPLE SUBMISSION
FLIGHT$Submitted = as.Date(FLIGHT$Submitted, "%m/%d/%y")
FLIGHT$ArrivalDate = as.Date(FLIGHT$ArrivalDate, "%m/%d/%y")
FLIGHT$year = FLIGHT$Submitted
FLIGHT$year = format(FLIGHT$year, format = "%Y")
FLIGHT$monthYear = FLIGHT$Submitted
FLIGHT$monthYear = format(FLIGHT$monthYear, format = "%y-%m")

# TOTAL NUMBER OF CLEARANCES IN EVALUATION
length(FLIGHT$Status)

# Simple Bar Plot of Flight Requests
barplot(table(FLIGHT$year), 
        main="Submissions",
        xlab="Submissions by Year",
        ylim = c(0,20000),
        border = "red",
        col = "blue",
        density = 50)

# CREATE SEPARATE TABLE OF CLEARANCE NUMBER AND FREQUENCY
Primary.list = as.data.frame(table(FLIGHT$Clearance))
Primary.list = Primary.list %>% arrange(-Freq)
plot(Primary.list$Freq, type="b", col="blue", lwd=2, pch=5, ylab="Used", xlab="Clearance Number", main="Plot of FLIGHT Clearance Numbers Issued")
text(Primary.list$Freq[1:10], labels=Primary.list$Freq[1:10], pos = 4, cex = .5)
abline(h=2000, col="red")

# SUBSET PRIMARY LIST BY CLEARANCE NUMBER TOTALS OVER 2000 AND SORT
Primary.list = Primary.list %>%
  filter(Freq > 2000) %>%
  arrange(-Freq)

# NUMBER OF CLEARANCES APPROVED BUT NOT PROCESSED BY DAO
blank.list = Primary.list %>% filter(Var1 == "")
blank.list$Freq / length(FLIGHT$Status)

# PULL NUMBER TO IDENTIFY HOW MANY PRIMARY BLANKET CLEARANCES USED
sum(Primary.list$Freq) - blank.list$Freq
round((sum(Primary.list$Freq) - blank.list$Freq)/length(FLIGHT$Status) * 100, digits = 2)
sprintf("In the past 7 years, we have cleared %s requests using our primary clearance.  This makes up %s percent of total clearances submitted to Germany", sum(Primary.list$Freq) - blank.list$Freq, round((sum(Primary.list$Freq) - blank.list$Freq)/length(FLIGHT$Status) * 100, digits = 2))
sprintf("In the past 7 years, the 618 AOC submitted %s requests with NA as action required and used our primary blanket clearance to process their flights.", blank.list$Freq)

# CREATE LIST OF PRIMARY CLEARANCE NUMBER
Clearance.list = as.vector(Primary.list$Var1)

# FILTER 1: FLIGHT DATASET BY PRIMARY CLEARANCE NUMBERS
blanket.list = filter(FLIGHT, Clearance %in% c(Clearance.list))

# PULL LENGTH OF FLIGHT OF ONLY PRIMARY CLARANCES AND BLANKS
length(blanket.list$Status)
round(length(blanket.list$Status)/length(FLIGHT$Status) * 100, digits = 2)

# TABLE OF ICAO USED OVER 1K TIMES 
ICAO.list = as.data.frame(table(blanket.list$ICAO)) %>% arrange(-Freq) 

plot(ICAO.list$Freq, type="b", col="blue", lwd=2, pch=5, ylab="Listed", xlab="ICAO", main="Plot of ICAO listed in Blanket Clearances")
text(ICAO.list$Freq[1:10], labels=ICAO.list$Freq[1:10], pos = 4, cex = .75)
abline(h = 1000, col = "red")

ICAO.list = ICAO.list %>% filter(Freq > 2000)

# TOP AIRPORT IN DATASET AND OVERFLIGHT IN DATASET
ICAO.list[1,2] / length(blanket.list$Status)

# CREATE LIST OF ICAO USED OVER 1K TIMES
ICAO.string = as.vector(ICAO.list$Var1)

# FILTER 2: BLANKET LIST DATASET OF ICAO USED OVER 1K TIMES
blanket.list = filter(blanket.list, ICAO %in% c(ICAO.string))

# FILTER 3: BLANKET LIST OF ONLY NON HAZMAT FLIGHTS
blanket.list = blanket.list %>% filter(Hazmat == FALSE)

# LENGTH OF LIST AFTER BLANKET, ICAO, HAZMAT FILTER; 80%
round(length(blanket.list$Status)/length(FLIGHT$Status)*100, digits = 2)

ICAO.string
sprintf("These six airfields and overflights make up %s percent of the total FLIGHT submitted in 7 years.", round(length(blanket.list$Status)/length(FLIGHT$Status)*100, digits = 2))

# TABLE OF OF AIRCRAFT TYPE AND FREQUENCY OF TYPE
type.list = as.data.frame(table(blanket.list$Type)) %>% arrange(-Freq)

# Creation of a Term Document Matrix for Aircraft Free text Submissions
doc = VCorpus(VectorSource(type.list$Var1))
transform = content_transformer(function(x, from, to) gsub(from, to, x))
temp = tm_map(doc, transform, "/", "")
temp = tm_map(temp, transform, "[^[:alnum:]]", "")
temp = tm_map(temp, transform, "[()]", "")
temp = tm_map(temp, transform, "200", " 200")
temp = tm_map(temp, transform, "300", " 300")
temp = tm_map(temp, transform, "400", " 400")
temp = tm_map(temp, transform, "500", " 500")
temp = tm_map(temp, transform, "800", " 800")
remove(doc)

dtm = TermDocumentMatrix(temp)
matrix = as.matrix(dtm)
words = sort(rowSums(matrix),decreasing=TRUE) 
df = data.frame(word = names(words),freq=words)
df$word = toupper(df$word)

# FOR LOOP TO COUNT APPEARANCE OF EACH TYPE OF SUBMISSION
for (i in 1:length(df$word)){
  a = blanket.list %>% filter(grepl(df$word[i], Type))
  a = length(a$Status)
  b = round((a / length(blanket.list$Status) * 100), digits = 2)
  df$Count[i] = a
  df$Percent[i] = b
}

# ARRANGE DATAFRAME LIST TO PLACE HIGHEST AT THE TOP
df = df %>% arrange(-Percent)

plot(df$Percent, type="b", col="green", lwd=2, pch=5, ylab="Aircraft Type Used", xlab = "Aircraft Type", main="Plot of Aircraft Inputs")
text(df$Percent, labels=df$Percent, pos = 4, cex = .5)
abline(h = 5.00, col = "red")

# FILTER AIRCRAFT LIST BY USING THE LEFT HAND RULE
Aircraft.list = df %>% filter(Percent > 4.00)
# TURN AIRCRAFT LIST INTO A VECTOR FOR FILTERING
AC.list = as.vector(Aircraft.list$word)

# REMOVE DUPLICATES TO REDUCE CONDITIONAL STATEMENTS 
remove = c("C12U","C17A","C130J","UC35A","B747","B7474","B74740","B767","UC3","400","300", "C135", "KC135")
AC.list = AC.list[! AC.list %in% remove]
AC.list

# CREATE A DUPLICATE DATAFRAME TO RUN FILTER 4 FOR AIRCRAFT LIST
filtered.list = blanket.list

# FILTER 4: FLIGHT DATASET BY TYPE OF AIRCRAFT
blanket.list = data.frame()
for (i in 1:length(AC.list)){
  D = filtered.list %>% filter(grepl(AC.list[i], Type))
  blanket.list = rbind(blanket.list, D)
  }

# FILTER 5: FLIGHT DATASET WITHOUT DV IN PURPOSE
blanket.list = blanket.list %>% filter(!str_detect(Purpose, "DV"))

# VIEW OF TABLE BY CLEARANCE NUMBER AND YEAR FOR COUNT
table(blanket.list$Clearance, blanket.list$year)

# CREATE FLIGHT TOTAL BY YEAR FOR FUTURE TABLE
FLIGHT.total = as.data.frame(table(FLIGHT$year))

# CREATE CURRENT BLANKET LIST TOTAL FOR FUTURE TABLE
blanketList.total = as.data.frame(table(blanket.list$year))

# CREATION OF TABLE FOR PRESENTATION
result = cbind(FLIGHT.total,blanketList.total$Freq)
colnames(result) = c('Year','All','Selected')
result$Percent = round(result$Selected/result$All * 100, digits = 2)
result

median(result$Percent)

# BUILDING OF JAVA ANGULAR STRING FOR SUBMISSION TO DOD
AC.list
ICAO.string

c = 0
for (i in 1:length(AC.list)){
  for (j in 1:length(ICAO.string)){
    c = c + 1
    string = sprintf("If 'Aircraft Type' contains (%s) & 'ICAO' = (%s) & 'Hazmat' = FALSE & 'Purpose' does not contain DV, then AUTO APPROVE",AC.list[i],ICAO.string[j])
    print(string)
      }
}

```
